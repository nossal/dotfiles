# vim: ft=tmux
# set -g  default-terminal   "${TERM}"
set -g  default-terminal   "tmux-256color"
set -as terminal-overrides ",*:RGB"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

set -as terminal-features ",*:hyperlinks"

if-shell "[[ $(uname -s) == Darwin ]]" {
  set-environment -g PATH "/opt/homebrew/bin:/usr/local/bin:/bin:/usr/bin"
}

set-option -gw xterm-keys on
set-option -gw mode-keys vi
unbind C-b
set -g prefix C-Space # Set prefix
set -gw mode-keys vi # Set mode keys to vi

set-option -g focus-events on
set-option -g set-titles on
set-option -g set-titles-string "#S / #W"

set -g base-index 1          # start indexing windows at 1 instead of 0
set -g detach-on-destroy off # don't exit from tmux when closing a session
set -g history-limit 1000000 # increase history size (from 2,000)
set -g mouse on              # enable mouse support
set -g renumber-windows on   # renumber all windows when any window is closed

# set -g set-clipboard on      # use system clipboard
# set -s copy-command "xsel -i"
set -g set-clipboard external

set -g @copy_use_osc52_fallback on

# Copy selected text
yank="~/.dotfiles/tmux/yank.sh"

bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "$yank"
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "$yank"
bind -T copy-mode-vi Y send-keys -X copy-line \;\
    run "tmux save-buffer - | $yank"
bind-key -T copy-mode-vi D send-keys -X copy-end-of-line \;\
    run "tmux save-buffer - | $yank"
bind -T copy-mode-vi C-j send-keys -X copy-pipe-and-cancel "$yank"
bind-key -T copy-mode-vi A send-keys -X append-selection-and-cancel \;\
    run "tmux save-buffer - | $yank"

# Copy selection on drag end event, but do not cancel copy mode and do not clear selection
# clear select on subsequence mouse click
bind -T copy-mode-vi MouseDragEnd1Pane \
       send-keys -X copy-pipe "$yank"
bind -T copy-mode-vi MouseDown1Pane select-pane \;\
       send-keys -X clear-selection


set -g status on
set -g status-justify left
set -g status-position bottom
# set -g status-left-length 30
set -g status-right-length 90

set -gq allow-passthrough on
set -g visual-activity off

set @datetime  "#[fg=#B0C0F2,bg=#2B51DB] %H:%M #[fg=#B4C1F0,bg=#2443B5,italics] %a#[noitalics] %d-%b"
set @panetitle "#[fg=#025A0E,bg=green,italics] #{=25:pane_title}#[noitalics]"
set @weather   "#[fg=#FFFFFF,bg=#4F6EE1,italics] clima #{clima}#[noitalics]"

set @prefix_fg_color "#{?client_prefix,#CEA820,white}"
set @window_zooned   "#{?window_zoomed_flag, ,  }"

set -gF status-left  "#[fg=#{@prefix_fg_color},bg=#F80C0C,bold]  #S "
set -gF status-right "#{@panetitle} #{@datetime}#[fg=#2443B5]▎"

set -gF window-status-current-format "#[fg=white,bg=#1E1E2E] #{@window_zooned} #W "
set -g  window-status-format "#[fg=gray,bg=#039016] #I #W "

# set -g window-status-separator "#[bg=#03B61B]▎"
setw -g window-status-separator ""

set -g pane-border-style "fg=#576062,bg=default"
set -g pane-active-border-style "fg=#464D4F,bg=default"

set -g popup-border-style "fg=#576062,bg=default"
set -g popup-border-lines "rounded"

set -g message-style "fg=#5C4B04,bg=#FFC40F"
set -g message-command-style ""

set -g @plugin "tmux-plugins/tpm"
set -g @plugin "tmux-plugins/tmux-sensible"
set -g @plugin "sainnhe/tmux-fzf"
set -g @plugin "tmux-plugins/tmux-yank"
set -g @plugin "tmux-plugins/tmux-resurrect"

# run "~/code/tmux-weather/tmux-weather.tmux"
run "~/.dotfiles/tmux/navigation.tmux"

# wg_is_keys_off="#[fg=$color_light,bg=$color_window_off_indicator]#([ $(tmux show-option -qv key-table) = 'off' ] && echo 'OFF')#[default]"

# When scrolling with mouse wheel, reduce number of scrolled rows per tick to "2" (default is 5)
bind -T copy-mode-vi WheelUpPane   select-pane \; send-keys -X -N 2 scroll-up
bind -T copy-mode-vi WheelDownPane select-pane \; send-keys -X -N 2 scroll-down

bind-key ! break-pane -d -t term_pane
bind-key @ join-pane -l 10 -t term_pane
bind-key v split-window -v -l 8 -c "#{pane_current_path}" \; select-pane -T term_pane -P "bg=#121119"
bind-key -n C-g display-popup -BE -s "bg=#111111" -d "#{pane_current_path}" -h 90% -w 80% "lazygit"

if-shell "test -n $SSH_CONNECTION" {
  source-file "~/.dotfiles/tmux/tmux-remote.conf"
}

bind -T root F12  \
       set prefix None \;\
       set key-table off \;\
       set status-left "#[fg=#FF3C3C,bg=#F80C0C,bold]  #S " \;\
       set -F window-status-current-format "#[fg=white,bg=#1E1E2E,italics] #{@window_zooned} #W  remote  F12 " \;\
       if -F '#{pane_in_mode}' 'send-keys -X cancel' \;\
       refresh-client -S \;\

bind -T off F12 \
       set -u prefix \;\
       set -u key-table \;\
       set -u status-left \;\
       set -u window-status-current-format \;\
       refresh-client -S

bind-key r source-file "~/.config/tmux/tmux.conf" \;\
    display-message " Hey! tmux.conf sourced!"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run "~/.tmux/plugins/tpm/tpm"

# ^[[>0;10;1c% weird characters fix
set -sg escape-time 50

